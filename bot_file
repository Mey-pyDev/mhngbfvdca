import disnake
from disnake.ext import commands
import random

intents = disnake.Intents.default()
intents.message_content = True
intents.reactions = True
intents.members = True

bot = commands.Bot(command_prefix='-', intents=intents)

# –°–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ –∏ –∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–µ
items = [
    {'emoji': 'üü©', 'name': 'Timetracker **Upwork Pavlo**', 'status': None},
    {'emoji': 'üîµ', 'name': 'Timetracker **Hubstuff Pavlo**', 'status': None},
    {'emoji': 'üîµ', 'name': 'Timetracker **Hubstuff "SoundBox"**', 'status': None},
]

adj = ['—Å–µ–∫—Å—É–∞–ª—å–Ω—ã–º', '—É–≤–∞–∂–∞–µ–º—ã–º', '–æ–±–æ—è—Ç–µ–ª—å–Ω—ã–º', '—Å–∏–ª—å–Ω—ã–º',
       '–±–∞—Å–∏—Å—Ç—ã–º', '–ø–æ—Ç—Ä—è—Å–∞—é—â–∏–º', '–ø—Ä–∏–∫–æ–ª–¥–µ—Å–Ω—ã–º', '–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –º–∞—Å—Ç–µ—Ä–æ–º',
       '—Å–∫–∏–ª–æ–≤—ã–º', '–Ω–∞—Ö–æ–¥—á–∏–≤—ã–º', '–ù–ï —Å–∫—É—Ñ–æ–º', '–¥–æ–±—Ä—ã–º', '–∞–Ω–∞–ª–∏—Ç–∏–∫–æ–º']

@bot.event
async def on_ready():
    print(f'Logged in as {bot.user}')


@bot.command(name='tracker')
async def items_command(ctx):
    for item in items:
        message = await ctx.send(f"{item['name']} —Å–≤–æ–±–æ–¥–µ–Ω\n\n")
        item['message_id'] = message.id
        await message.add_reaction(item['emoji'])


async def process_reaction(payload, add):

    guild = bot.get_guild(payload.guild_id)
    channel = guild.get_channel(payload.channel_id)
    message = await channel.fetch_message(payload.message_id)
    user = guild.get_member(payload.user_id)

    if user is None or user.bot:
        return

    if message.author != bot.user:
        return

    for item in items:
        if payload.message_id == item.get('message_id') and str(payload.emoji) == item['emoji']:
            if add:
                if item['status'] is None:
                    # –ó–∞–Ω–∏–º–∞–µ–º –ø—É–Ω–∫—Ç
                    item['status'] = user
                    await message.edit(content=f"{item['name']} –∑–∞–Ω—è—Ç {random.choice(adj)} {user.mention}\n")
                else:
                    # –ü—É–Ω–∫—Ç —É–∂–µ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                    await channel.send(f'{user.mention}, —ç—Ç–æ—Ç —Ç—Ä–µ–∫–µ—Ä —É–∂–µ –∑–∞–Ω—è—Ç {item["status"].mention}.',
                                       delete_after=5)
                    await message.remove_reaction(payload.emoji, user)
            else:
                if item['status'] == user:
                    # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø—É–Ω–∫—Ç
                    item['status'] = None
                    await message.edit(content=f"{item['name']} —Å–≤–æ–±–æ–¥–µ–Ω\n")


@bot.event
async def on_raw_reaction_add(payload):
    await process_reaction(payload, True)


@bot.event
async def on_raw_reaction_remove(payload):
    await process_reaction(payload, False)


# –ó–∞–º–µ–Ω–∏—Ç–µ 'YOUR_TOKEN_HERE' –Ω–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
bot.run('MTI0NzU0MTY2NjU2MzQ4OTg2NA.GsTV9S.H6HAPkA03QiyDlhh3AH2yODmAL7-s6QzyAzmh4')
